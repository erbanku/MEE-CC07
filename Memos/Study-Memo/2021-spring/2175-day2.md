# 树莓派基础

今天老师给我们讲解了树莓派GPIO相关的使用。由于有相关基础，这次课显得较为容易。我分别尝试了采用 `sysfs` 接口和 `RPi-GPIO` 库两种方法进行实验。
其中，对于采用 `RPi-GPIO` 库的方法，我尝试使用了轮询和单独回调线程2种方法。

## 闪烁

采用 Shell 脚本实现，代码如下：
```bash
#!/bin/bash

cd /sys/class/gpio
if ! [ -e gpio25 ]; then
  echo 25 > export 
fi
cd gpio25
echo out > direction

while true; do
	echo 1 > value
	sleep 1
	echo 0 > value
	sleep 1
done
```

## 闪烁（状态机）

状态机可以在 `OFF`, `BLINK`, `ON` 三种状态之间切换，切换条件为按钮输入下降沿。按钮采用上拉电阻，这样在断路时输入引脚就会被上拉到3.3V。
采用单独线程处理下降沿回调函数，并且切换状态。代码如下：
```python
import RPi.GPIO as GPIO
from enum import IntEnum
from time import sleep

class State(IntEnum):
	OFF = 0
	BLINK = 1
	ON = 2

current_state = State.OFF
input_port = 23
output_port = 25

def main():
	GPIO.setmode(GPIO.BCM)
	GPIO.setup(input_port, GPIO.IN)
	GPIO.setup(output_port, GPIO.OUT)
	
	def negedge_callback(port):
		global current_state
		current_state = State((current_state + 1) % 3) 
	
	GPIO.add_event_detect(input_port, GPIO.FALLING, bouncetime=200)
	GPIO.add_event_callback(input_port, negedge_callback)

	while True:
		if current_state == State.OFF:
			GPIO.output(output_port, GPIO.LOW)
		elif current_state == State.BLINK:
			GPIO.output(output_port, not GPIO.input(output_port))
		elif current_state == State.ON:
			GPIO.output(output_port, GPIO.HIGH)
		sleep(0.1)

def clear():
	GPIO.output(output_port, GPIO.LOW)

if __name__ == '__main__':
	try:
		main()
	except KeyboardInterrupt:
		clear()
		print('Keyboard Interrupt. Exiting...')
```

## 计数器

采用轮询方法。按钮按下时为低电平，此时同步重置计数器。否则，每次循环时将计数器加一，再对3取按位与。代码如下：
```python
import RPi.GPIO as GPIO
from enum import IntEnum
from time import sleep

counter = 0
input_port = 23
output_bit1_port = 24
output_bit0_port = 25

def main():
	global counter

	GPIO.setmode(GPIO.BCM)
	GPIO.setup(input_port, GPIO.IN)
	GPIO.setup(output_bit1_port, GPIO.OUT)
	GPIO.setup(output_bit0_port, GPIO.OUT)
	
	while True:
		if not GPIO.input(input_port):
			counter = 0			
		else:
			counter = (counter + 1) & 3
		GPIO.output(output_bit1_port, counter >> 1)
		GPIO.output(output_bit0_port, counter & 1)
		sleep(1)

def clear():
	GPIO.output(output_bit1_port, GPIO.LOW)
	GPIO.output(output_bit0_port, GPIO.LOW)

if __name__ == '__main__':
	try:
		main()
	except KeyboardInterrupt:
		clear()
		print('Keyboard Interrupt. Exiting...')
```